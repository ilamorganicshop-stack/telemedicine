{% extends 'medical/base.html' %}

{% block title %}Book Appointment - Telemedicine System{% endblock %}

{% block medical_content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Book Appointment</h1>
        <p class="text-gray-600 mt-2">Schedule a consultation with one of our healthcare professionals</p>
    </div>

    <div class="bg-white shadow-md rounded-lg p-6">
        <form method="post">
            {% csrf_token %}
            
            <div class="mb-6">
                <label for="hospital" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Hospital
                </label>
                <select name="hospital" id="hospital" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Choose a hospital...</option>
                    {% for hospital in hospitals %}
                        <option value="{{ hospital.id }}">{{ hospital.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-6">
                <label for="doctor" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Doctor
                </label>
                <select name="doctor" id="doctor" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Choose a doctor...</option>
                    {% for doctor in doctors %}
                        <option value="{{ doctor.user.id }}" 
                                data-hospital="{{ doctor.hospital.id }}"
                                {% if not doctor.is_available %}disabled{% endif %}>
                            Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }} - 
                            {{ doctor.specialization }} ({{ doctor.hospital.name }})
                            {% if not doctor.is_available %} - Not Available{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-6">
                <label for="appointment_date" class="block text-sm font-medium text-gray-700 mb-2">
                    Appointment Date & Time
                </label>
                <input type="datetime-local" 
                       name="appointment_date" 
                       id="appointment_date" 
                       required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="mt-1 text-sm text-gray-500">
                    Please select a date and time at least 24 hours from now
                </p>
            </div>

            <div class="mb-6">
                <label for="symptoms" class="block text-sm font-medium text-gray-700 mb-2">
                    Symptoms / Reason for Visit (Optional)
                </label>
                <textarea name="symptoms" 
                          id="symptoms" 
                          rows="4"
                          placeholder="Please describe your symptoms or the reason for your visit..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <div class="flex items-center justify-between">
                <a href="{% url 'medical:doctor_list' %}" 
                   class="text-gray-600 hover:text-gray-800">
                    Cancel
                </a>
                <button type="submit" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Book Appointment
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hospitalSelect = document.getElementById('hospital');
    const doctorSelect = document.getElementById('doctor');
    const appointmentDateInput = document.getElementById('appointment_date');
    
    // Filter doctors based on selected hospital
    hospitalSelect.addEventListener('change', function() {
        const selectedHospitalId = this.value;
        const doctors = doctorSelect.querySelectorAll('option');
        
        doctorSelect.value = ''; // Reset doctor selection
        
        doctors.forEach(doctor => {
            if (doctor.value === '') {
                doctor.style.display = 'block'; // Show placeholder
                return;
            }
            
            const doctorHospitalId = doctor.getAttribute('data-hospital');
            if (selectedHospitalId === '' || doctorHospitalId === selectedHospitalId) {
                doctor.style.display = 'block';
            } else {
                doctor.style.display = 'none';
            }
        });
    });
    
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDateTime = tomorrow.toISOString().slice(0, 16);
    appointmentDateInput.min = minDateTime;
    
    // Validate appointment time (business hours)
    appointmentDateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const hours = selectedDate.getHours();
        const dayOfWeek = selectedDate.getDay();
        
        // Check if it's weekend (0 = Sunday, 6 = Saturday)
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            alert('Appointments are only available on weekdays (Monday - Friday).');
            this.value = '';
            return;
        }
        
        // Check if it's outside business hours (9 AM - 5 PM)
        if (hours < 9 || hours >= 17) {
            alert('Appointments are only available between 9:00 AM and 5:00 PM.');
            this.value = '';
            return;
        }
    });
});
</script>
{% endblock %}