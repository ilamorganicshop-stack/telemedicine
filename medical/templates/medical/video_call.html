{% extends 'medical/base.html' %}

{% block title %}HD Video Call - Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }} & {{ appointment.patient.first_name }} {{ appointment.patient.last_name }}{% endblock %}

{% block extra_css %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        height: 70vh;
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .remote-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .local-video {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 200px;
        height: 150px;
        border-radius: 8px;
        border: 2px solid #fff;
        object-fit: cover;
        z-index: 10;
        background: #000;
    }
    
    .call-controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.6);
        padding: 15px 25px;
        border-radius: 50px;
    }
    
    .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .control-btn:hover {
        transform: scale(1.1);
    }
    
    .btn-mute {
        background: #4a5568;
        color: white;
    }
    
    .btn-mute.muted {
        background: #e53e3e;
    }
    
    .btn-video {
        background: #4a5568;
        color: white;
    }
    
    .btn-video.off {
        background: #e53e3e;
    }
    
    .btn-screen {
        background: #3182ce;
        color: white;
    }
    
    .btn-end {
        background: #e53e3e;
        color: white;
    }
    
    .btn-fullscreen {
        background: #4a5568;
        color: white;
    }
    
    .waiting-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30;
        color: white;
    }
    
    .waiting-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #fff;
        border-top-color: #3182ce;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .connection-quality {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 20;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quality-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .quality-excellent { background: #48bb78; }
    .quality-good { background: #ecc94b; }
    .quality-poor { background: #e53e3e; }
    
    .in-call-chat {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 300px;
        height: 300px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 12px;
        z-index: 20;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 12px 15px;
        border-bottom: 1px solid #444;
        color: white;
        font-weight: 600;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }
    
    .chat-input-area {
        padding: 10px;
        border-top: 1px solid #444;
        display: flex;
        gap: 8px;
    }
    
    .chat-input {
        flex: 1;
        padding: 8px 12px;
        border-radius: 20px;
        border: none;
        background: #333;
        color: white;
    }
    
    .chat-send {
        padding: 8px 15px;
        background: #3182ce;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
    
    .chat-message {
        margin-bottom: 8px;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .chat-message.self {
        background: #3182ce;
        color: white;
        margin-left: auto;
    }
    
    .chat-message.other {
        background: #4a5568;
        color: white;
    }
    
    .chat-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 25;
    }
</style>
{% endblock %}

{% block medical_content %}
<div class="mb-4">
    <a href="{% url 'medical:chat' appointment.id %}" class="text-blue-600 hover:text-blue-800">
        ‚Üê Back to Chat
    </a>
</div>

<div class="video-container" id="videoContainer">
    <!-- Remote Video (Doctor or Patient) -->
    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
    
    <!-- Local Video (Self) -->
    <video id="localVideo" class="local-video" autoplay playsinline muted></video>
    
    <!-- Connection Quality Indicator -->
    <div class="connection-quality">
        <div class="quality-indicator quality-excellent" id="qualityIndicator"></div>
        <span id="qualityText">Excellent</span>
        <span id="connectionStats"></span>
    </div>
    
    <!-- Waiting Room Overlay (shown to patient until doctor joins) -->
    {% if user_type == 'patient' and appointment.video_call_status == 'waiting' %}
    <div class="waiting-overlay" id="waitingOverlay">
        <div class="waiting-spinner"></div>
        <h3 class="text-xl font-semibold mb-2">Waiting for Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }}</h3>
        <p class="text-gray-300">The doctor will join shortly...</p>
    </div>
    {% endif %}
    
    <!-- In-Call Chat -->
    <button class="chat-toggle bg-blue-500 text-white px-4 py-2 rounded-lg" onclick="toggleChat()">
        üí¨ Chat
    </button>
    
    <div class="in-call-chat" id="inCallChat" style="display: none;">
        <div class="chat-header">In-Call Messages</div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
    
    <!-- Call Controls -->
    <div class="call-controls">
        <button class="control-btn btn-mute" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </button>
        
        <button class="control-btn btn-video" id="videoBtn" onclick="toggleVideo()" title="Camera On/Off">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
        </button>
        
        {% if user_type == 'doctor' %}
        <button class="control-btn btn-screen" id="screenBtn" onclick="toggleScreenShare()" title="Share Screen">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
            </svg>
        </button>
        {% endif %}
        
        <button class="control-btn btn-fullscreen" onclick="toggleFullscreen()" title="Fullscreen">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            </svg>
        </button>
        
        <button class="control-btn btn-end" onclick="endCall()" title="End Call">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.51-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/>
            </svg>
        </button>
    </div>
</div>

<div class="mt-4 bg-white p-4 rounded-lg shadow">
    <h3 class="font-semibold text-gray-800 mb-2">Call Information</h3>
    <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
            <span class="text-gray-600">Patient:</span>
            <span class="font-medium">{{ appointment.patient.first_name }} {{ appointment.patient.last_name }}</span>
        </div>
        <div>
            <span class="text-gray-600">Doctor:</span>
            <span class="font-medium">Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }}</span>
        </div>
        <div>
            <span class="text-gray-600">Status:</span>
            <span class="font-medium" id="callStatus">{{ appointment.get_video_call_status_display }}</span>
        </div>
        <div>
            <span class="text-gray-600">Duration:</span>
            <span class="font-medium" id="callDuration">00:00</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // WebRTC Configuration
    const webrtcConfig = JSON.parse('{{ webrtc_config|safe }}');
    const roomId = '{{ room_id }}';
    const userType = '{{ user_type }}';
    const appointmentId = '{{ appointment.id }}';
    
    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let websocket = null;
    let isMuted = false;
    let isVideoOff = false;
    let isScreenSharing = false;
    let callStartTime = null;
    let durationInterval = null;
    
    // WebSocket connection for signaling
    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${wsScheme}://${window.location.host}/ws/video-call/${roomId}/`;
    
    // ICE Servers configuration
    const iceServers = {
        iceServers: [
            ...webrtcConfig.stun_servers.map(url => ({ urls: url })),
            ...webrtcConfig.turn_servers.map(server => ({
                urls: server.urls,
                username: server.username,
                credential: server.credential
            }))
        ]
    };
    
    // Initialize WebSocket
    function initializeWebSocket() {
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function() {
            console.log('WebSocket connected');
            // Send join message
            websocket.send(JSON.stringify({
                type: 'join',
                user_type: userType,
                user_name: userType === 'doctor' ? 'Doctor' : 'Patient'
            }));
        };
        
        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleSignalingMessage(data);
        };
        
        websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        websocket.onclose = function() {
            console.log('WebSocket disconnected');
            // Attempt to reconnect after 3 seconds
            setTimeout(initializeWebSocket, 3000);
        };
    }
    
    // Handle signaling messages
    function handleSignalingMessage(data) {
        switch(data.type) {
            case 'offer':
                handleOffer(data.offer);
                break;
            case 'answer':
                handleAnswer(data.answer);
                break;
            case 'ice-candidate':
                handleIceCandidate(data.candidate);
                break;
            case 'user-joined':
                if (data.user_type !== userType) {
                    console.log(`${data.user_name} joined the call`);
                    // Remove waiting overlay if patient
                    if (userType === 'patient') {
                        document.getElementById('waitingOverlay').style.display = 'none';
                    }
                    // Start call timer
                    startCallTimer();
                }
                break;
            case 'user-left':
                console.log(`${data.user_name} left the call`);
                break;
            case 'chat':
                displayChatMessage(data.message, data.sender, false);
                break;
            case 'screen-share':
                handleScreenShareStatus(data.is_sharing);
                break;
        }
    }
    
    // Initialize WebRTC
    async function initializeWebRTC() {
        try {
            // Get local media stream
            localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });
            
            // Display local video
            const localVideo = document.getElementById('localVideo');
            localVideo.srcObject = localStream;
            
            // Create peer connection
            createPeerConnection();
            
            // Add local stream tracks to peer connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Initialize WebSocket
            initializeWebSocket();
            
            // Monitor connection quality
            monitorConnectionQuality();
            
        } catch (error) {
            console.error('Error accessing media devices:', error);
            alert('Could not access camera or microphone. Please check permissions.');
        }
    }
    
    // Create RTCPeerConnection
    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(iceServers);
        
        // Handle remote stream
        peerConnection.ontrack = function(event) {
            if (event.streams && event.streams[0]) {
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = remoteStream;
            }
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = function(event) {
            if (event.candidate) {
                websocket.send(JSON.stringify({
                    type: 'ice-candidate',
                    candidate: event.candidate
                }));
            }
        };
        
        // Handle connection state changes
        peerConnection.onconnectionstatechange = function() {
            console.log('Connection state:', peerConnection.connectionState);
            updateConnectionStatus();
        };
    }
    
    // Create and send offer (caller)
    async function createOffer() {
        try {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            websocket.send(JSON.stringify({
                type: 'offer',
                offer: offer
            }));
        } catch (error) {
            console.error('Error creating offer:', error);
        }
    }
    
    // Handle received offer (callee)
    async function handleOffer(offer) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            websocket.send(JSON.stringify({
                type: 'answer',
                answer: answer
            }));
        } catch (error) {
            console.error('Error handling offer:', error);
        }
    }
    
    // Handle received answer (caller)
    async function handleAnswer(answer) {
        try {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        } catch (error) {
            console.error('Error handling answer:', error);
        }
    }
    
    // Handle ICE candidate
    async function handleIceCandidate(candidate) {
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (error) {
            console.error('Error adding ICE candidate:', error);
        }
    }
    
    // Toggle mute
    function toggleMute() {
        const audioTracks = localStream.getAudioTracks();
        isMuted = !isMuted;
        
        audioTracks.forEach(track => {
            track.enabled = !isMuted;
        });
        
        const muteBtn = document.getElementById('muteBtn');
        if (isMuted) {
            muteBtn.classList.add('muted');
            muteBtn.innerHTML = `
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                </svg>
            `;
        } else {
            muteBtn.classList.remove('muted');
            muteBtn.innerHTML = `
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            `;
        }
    }
    
    // Toggle video
    function toggleVideo() {
        const videoTracks = localStream.getVideoTracks();
        isVideoOff = !isVideoOff;
        
        videoTracks.forEach(track => {
            track.enabled = !isVideoOff;
        });
        
        const videoBtn = document.getElementById('videoBtn');
        if (isVideoOff) {
            videoBtn.classList.add('off');
            videoBtn.innerHTML = `
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 6.5l-4 4V7c0-.55-.45-1-1-1H9.82L21 17.18V6.5zM3.27 2L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.55-.18L19.73 21 21 19.73 3.27 2z"/>
                </svg>
            `;
        } else {
            videoBtn.classList.remove('off');
            videoBtn.innerHTML = `
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                </svg>
            `;
        }
    }
    
    // Toggle screen sharing (doctor only)
    async function toggleScreenShare() {
        if (!isScreenSharing) {
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: 'always' },
                    audio: false
                });
                
                // Replace video track with screen track
                const videoTrack = screenStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => 
                    s.track && s.track.kind === 'video'
                );
                
                if (sender) {
                    sender.replaceTrack(videoTrack);
                }
                
                // Handle screen share stop
                videoTrack.onended = () => {
                    stopScreenSharing();
                };
                
                isScreenSharing = true;
                document.getElementById('screenBtn').classList.add('active');
                
                // Notify other peer
                websocket.send(JSON.stringify({
                    type: 'screen-share',
                    is_sharing: true
                }));
                
            } catch (error) {
                console.error('Error sharing screen:', error);
            }
        } else {
            stopScreenSharing();
        }
    }
    
    // Stop screen sharing
    async function stopScreenSharing() {
        if (!isScreenSharing) return;
        
        // Get camera stream again
        const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        const videoTrack = cameraStream.getVideoTracks()[0];
        
        const sender = peerConnection.getSenders().find(s => 
            s.track && s.track.kind === 'video'
        );
        
        if (sender) {
            sender.replaceTrack(videoTrack);
        }
        
        isScreenSharing = false;
        document.getElementById('screenBtn').classList.remove('active');
        
        // Notify other peer
        websocket.send(JSON.stringify({
            type: 'screen-share',
            is_sharing: false
        }));
    }
    
    // Handle screen share status from other peer
    function handleScreenShareStatus(isSharing) {
        if (isSharing) {
            console.log('Other user is sharing their screen');
        } else {
            console.log('Other user stopped sharing screen');
        }
    }
    
    // Toggle fullscreen
    function toggleFullscreen() {
        const container = document.getElementById('videoContainer');
        
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                console.error('Error entering fullscreen:', err);
            });
        } else {
            document.exitFullscreen();
        }
    }
    
    // End call
    function endCall() {
        // Send leave message
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({
                type: 'leave',
                user_type: userType,
                user_name: userType === 'doctor' ? 'Doctor' : 'Patient'
            }));
        }
        
        // Stop all tracks
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        
        // Close peer connection
        if (peerConnection) {
            peerConnection.close();
        }
        
        // Close WebSocket
        if (websocket) {
            websocket.close();
        }
        
        // Stop timer
        if (durationInterval) {
            clearInterval(durationInterval);
        }
        
        // Redirect to end call endpoint
        window.location.href = `/medical/appointments/${appointmentId}/video-call/end/`;
    }
    
    // Toggle chat visibility
    function toggleChat() {
        const chat = document.getElementById('inCallChat');
        chat.style.display = chat.style.display === 'none' ? 'flex' : 'none';
    }
    
    // Send chat message
    function sendChatMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (message && websocket) {
            websocket.send(JSON.stringify({
                type: 'chat',
                message: message,
                sender: userType === 'doctor' ? 'Dr. {{ appointment.doctor.last_name }}' : '{{ appointment.patient.first_name }}'
            }));
            
            displayChatMessage(message, 'You', true);
            input.value = '';
        }
    }
    
    // Handle chat key press
    function handleChatKeyPress(event) {
        if (event.key === 'Enter') {
            sendChatMessage();
        }
    }
    
    // Display chat message
    function displayChatMessage(message, sender, isSelf) {
        const container = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isSelf ? 'self' : 'other'}`;
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }
    
    // Start call timer
    function startCallTimer() {
        if (callStartTime) return;
        
        callStartTime = new Date();
        durationInterval = setInterval(() => {
            const now = new Date();
            const diff = Math.floor((now - callStartTime) / 1000);
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
        }, 1000);
    }
    
    // Monitor connection quality
    function monitorConnectionQuality() {
        setInterval(() => {
            if (!peerConnection) return;
            
            const stats = peerConnection.getStats();
            stats.then(report => {
                let packetsLost = 0;
                let packetsReceived = 0;
                
                report.forEach(stat => {
                    if (stat.type === 'inbound-rtp' && stat.mediaType === 'video') {
                        packetsLost = stat.packetsLost || 0;
                        packetsReceived = stat.packetsReceived || 1;
                    }
                });
                
                const lossRate = packetsReceived > 0 ? (packetsLost / packetsReceived) * 100 : 0;
                updateQualityIndicator(lossRate);
            });
        }, 5000);
    }
    
    // Update quality indicator
    function updateQualityIndicator(lossRate) {
        const indicator = document.getElementById('qualityIndicator');
        const text = document.getElementById('qualityText');
        
        indicator.classList.remove('quality-excellent', 'quality-good', 'quality-poor');
        
        if (lossRate < 2) {
            indicator.classList.add('quality-excellent');
            text.textContent = 'Excellent';
        } else if (lossRate < 5) {
            indicator.classList.add('quality-good');
            text.textContent = 'Good';
        } else {
            indicator.classList.add('quality-poor');
            text.textContent = 'Poor';
        }
    }
    
    // Update connection status display
    function updateConnectionStatus() {
        const statusEl = document.getElementById('callStatus');
        if (peerConnection) {
            statusEl.textContent = peerConnection.connectionState;
        }
    }
    
    // Handle page unload
    window.addEventListener('beforeunload', function() {
        if (websocket) {
            websocket.close();
        }
        if (peerConnection) {
            peerConnection.close();
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeWebRTC();
        
        // If doctor, create offer after a short delay
        if (userType === 'doctor') {
            setTimeout(() => {
                if (peerConnection) {
                    createOffer();
                }
            }, 2000);
        }
    });
</script>
{% endblock %}
